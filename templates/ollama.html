<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama-modellhantering - Remissorterare</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .ollama-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .model-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .model-card.recommended {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        }
        
        .model-card.installed {
            border-color: #2196F3;
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4ff 100%);
        }
        
        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .model-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .model-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .badge-recommended {
            background: #4CAF50;
            color: white;
        }
        
        .badge-installed {
            background: #2196F3;
            color: white;
        }
        
        .model-info {
            margin: 10px 0;
        }
        
        .model-info span {
            display: block;
            margin: 5px 0;
            color: #666;
        }
        
        .model-actions {
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-warning {
            background: #FF9800;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .status-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
        }
        
        .status-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .status-value {
            color: #666;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success {
            color: #4CAF50;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="ollama-container">
        <header>
            <h1>ü§ñ Ollama-modellhantering</h1>
            <p>Hantera och konfigurera Ollama-modeller f√∂r Remissorterare</p>
            <a href="/" class="btn btn-primary">‚Üê Tillbaka till huvudsidan</a>
        </header>

        <div class="status-section">
            <h2>üìä Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Ollama-status</div>
                    <div class="status-value" id="ollama-status">Kontrollerar...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Aktuell modell</div>
                    <div class="status-value" id="current-model">Laddar...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Installerade modeller</div>
                    <div class="status-value" id="installed-count">Laddar...</div>
                </div>
            </div>
        </div>

        <div class="status-section">
            <h2>üîß Snabba √•tg√§rder</h2>
            <button class="btn btn-primary" onclick="refreshStatus()">üîÑ Uppdatera status</button>
            <button class="btn btn-success" onclick="installDefaultModel()">üì• Installera standardmodell</button>
            <button class="btn btn-warning" onclick="testCurrentModel()">üß™ Testa aktuell modell</button>
        </div>

        <div class="status-section">
            <h2>üì¶ Tillg√§ngliga modeller</h2>
            <div id="models-container">
                <p>Laddar modeller...</p>
            </div>
        </div>
    </div>

    <script>
        // Ladda status n√§r sidan laddas
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            loadModels();
        });

        async function refreshStatus() {
            try {
                // Kontrollera Ollama-status
                const statusResponse = await fetch('/api/ollama_installerade');
                const statusData = await statusResponse.json();
                
                if (statusData.success) {
                    document.getElementById('ollama-status').textContent = '‚úÖ Ig√•ng';
                    document.getElementById('installed-count').textContent = statusData.installerade_modeller.length;
                } else {
                    document.getElementById('ollama-status').textContent = '‚ùå Stoppad';
                    document.getElementById('installed-count').textContent = '0';
                }
                
                // H√§mta aktuell modell
                const currentResponse = await fetch('/api/lokal_ai_status');
                const currentData = await currentResponse.json();
                
                if (currentData.success) {
                    document.getElementById('current-model').textContent = currentData.modell || 'Ok√§nd';
                } else {
                    document.getElementById('current-model').textContent = 'Kunde inte h√§mta';
                }
                
            } catch (error) {
                console.error('Fel vid uppdatering av status:', error);
                document.getElementById('ollama-status').textContent = '‚ùå Fel';
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/api/ollama_modeller');
                const data = await response.json();
                
                if (data.success) {
                    const modelsContainer = document.getElementById('models-container');
                    modelsContainer.innerHTML = '';
                    
                    // H√§mta installerade modeller f√∂r j√§mf√∂relse
                    const installedResponse = await fetch('/api/ollama_installerade');
                    const installedData = installedResponse.json();
                    const installedModels = installedData.success ? installedData.installerade_modeller : [];
                    
                    // Skapa modellkort
                    Object.entries(data.modeller).forEach(([modelName, modelInfo]) => {
                        const isRecommended = data.rekommenderade.includes(modelName);
                        const isInstalled = installedModels.includes(modelName);
                        
                        const modelCard = document.createElement('div');
                        modelCard.className = `model-card ${isRecommended ? 'recommended' : ''} ${isInstalled ? 'installed' : ''}`;
                        
                        modelCard.innerHTML = `
                            <div class="model-header">
                                <div class="model-name">${modelName}</div>
                                <div>
                                    ${isRecommended ? '<span class="model-badge badge-recommended">Rekommenderad</span>' : ''}
                                    ${isInstalled ? '<span class="model-badge badge-installed">Installerad</span>' : ''}
                                </div>
                            </div>
                            <div class="model-info">
                                <span><strong>Beskrivning:</strong> ${modelInfo.description}</span>
                                <span><strong>Storlek:</strong> ${modelInfo.size}</span>
                                <span><strong>Spr√•k:</strong> ${modelInfo.language}</span>
                                <span><strong>Prestanda:</strong> ${modelInfo.performance}</span>
                                <span><strong>Minne:</strong> ${modelInfo.memory}</span>
                            </div>
                            <div class="model-actions">
                                ${!isInstalled ? `<button class="btn btn-success" onclick="installModel('${modelName}')">üì• Installera</button>` : ''}
                                ${isInstalled ? `<button class="btn btn-primary" onclick="switchToModel('${modelName}')">üîÑ Byt till</button>` : ''}
                                ${isInstalled ? `<button class="btn btn-warning" onclick="testModel('${modelName}')">üß™ Testa</button>` : ''}
                            </div>
                        `;
                        
                        modelsContainer.appendChild(modelCard);
                    });
                } else {
                    document.getElementById('models-container').innerHTML = '<p class="error">Kunde inte ladda modeller</p>';
                }
                
            } catch (error) {
                console.error('Fel vid laddning av modeller:', error);
                document.getElementById('models-container').innerHTML = '<p class="error">Fel vid laddning av modeller</p>';
            }
        }

        async function installModel(modelName) {
            if (!confirm(`Vill du installera modellen "${modelName}"? Detta kan ta flera minuter.`)) {
                return;
            }
            
            try {
                // Visa laddningsindikator
                const button = event.target;
                button.textContent = 'üì• Installerar...';
                button.disabled = true;
                
                // Anv√§nd ollama_manager.py f√∂r installation
                const response = await fetch('/api/install_ollama_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ model: modelName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`‚úÖ Modell ${modelName} installerades framg√•ngsrikt!`, 'success');
                    loadModels(); // Uppdatera modelllistan
                } else {
                    showMessage(`‚ùå Fel vid installation: ${data.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Fel vid installation:', error);
                showMessage('‚ùå Fel vid installation av modell', 'error');
            } finally {
                // √Öterst√§ll knappen
                const button = event.target;
                button.textContent = 'üì• Installera';
                button.disabled = false;
            }
        }

        async function switchToModel(modelName) {
            try {
                const response = await fetch('/api/byt_ollama_modell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ modell: modelName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`‚úÖ Bytte till modell: ${modelName}`, 'success');
                    refreshStatus();
                } else {
                    showMessage(`‚ùå Kunde inte byta modell: ${data.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Fel vid byte av modell:', error);
                showMessage('‚ùå Fel vid byte av modell', 'error');
            }
        }

        async function testModel(modelName) {
            try {
                showMessage(`üß™ Testar modell ${modelName}...`, 'success');
                
                // Byt till modellen f√∂rst
                await switchToModel(modelName);
                
                // Testa med en enkel prompt
                const testResponse = await fetch('/api/analysera_text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: "Remiss till gynekologiska kliniken f√∂r utredning av cysta" 
                    })
                });
                
                const testData = await testResponse.json();
                
                if (testData.success) {
                    showMessage(`‚úÖ Test lyckades! Resultat: ${testData.verksamhet} (${testData.sannolikhet}%)`, 'success');
                } else {
                    showMessage(`‚ùå Test misslyckades: ${testData.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Fel vid testning:', error);
                showMessage('‚ùå Fel vid testning av modell', 'error');
            }
        }

        async function installDefaultModel() {
            await installModel('llama2:7b');
        }

        async function testCurrentModel() {
            const currentModel = document.getElementById('current-model').textContent;
            if (currentModel && currentModel !== 'Kunde inte h√§mta') {
                await testModel(currentModel);
            } else {
                showMessage('‚ùå Kan inte identifiera aktuell modell', 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            const container = document.querySelector('.ollama-container');
            container.insertBefore(messageDiv, container.firstChild);
            
            // Ta bort meddelandet efter 5 sekunder
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
